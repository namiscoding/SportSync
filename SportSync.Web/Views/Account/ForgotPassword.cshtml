@model SportSync.Web.Models.ViewModels.Account.ForgotPasswordViewModel
@{
    ViewData["Title"] = "Quên Mật Khẩu";
    Layout = "_AuthLayout"; // Nếu bạn có layout riêng
}

<div class="auth-content">
    <h4 class="auth-title">Quên mật khẩu</h4>
    <p class="auth-subtitle">Vui lòng nhập số điện thoại đã đăng ký để nhận mã OTP và đặt lại mật khẩu.</p>

    <div id="status-container"></div> @* Container mới cho thông báo động *@

    @* Bước 1: Nhập Số Điện Thoại *@
    <div id="phoneNumberSection">
        <h5 class="step-title">Xác thực số điện thoại của bạn</h5>
        <hr />
        <div class="form-group mb-3">
            <label for="phoneNumberInput" class="form-label">Số điện thoại</label>
            <input asp-for="PhoneNumber" class="form-control" id="phoneNumberInput" placeholder="Nhập số điện thoại" />
            <span id="phoneNumberError" class="text-danger d-block mt-1"></span>
        </div>
        <button type="button" id="sendOtpButton" class="btn btn-primary">
            <span class="button-text">Gửi Mã OTP</span>
            <span id="loader" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
        </button>
    </div>

    @* Bước 2: Nhập OTP và Mật khẩu mới (kết hợp) *@
    <div id="resetPasswordSection" style="display: none;">
        <h5 class="step-title">Đặt lại mật khẩu cho <strong id="phoneNumberDisplay"></strong></h5>
        <hr />
        <form id="resetPasswordForm" asp-action="ResetPassword" asp-controller="Account" method="post">
            @Html.AntiForgeryToken()
            <div asp-validation-summary="ModelOnly" class="text-danger alert alert-danger small p-2 mb-3" role="alert"></div>

            <input type="hidden" name="PhoneNumber" id="hiddenPhoneNumber" />

            <div class="form-group mb-3">
                <label for="otpInput" class="form-label">Mã OTP (6 chữ số)</label>
                <input name="OtpCode" type="tel" class="form-control" id="otpInput" placeholder="Mã OTP" required />
                <span class="text-danger" data-valmsg-for="OtpCode"></span>
            </div>

            <div class="form-group mb-3 password-input-container">
                <label for="newPasswordInput" class="form-label">Mật khẩu mới</label>
                <input name="Password" type="password" class="form-control" id="newPasswordInput" autocomplete="new-password" placeholder="Mật khẩu mới" required />
                <span class="password-toggle-icon" data-target-id="newPasswordInput"><i class="fas fa-eye"></i></span>
                <span class="text-danger" data-valmsg-for="Password"></span>
            </div>

            <div class="form-group mb-4 password-input-container">
                <label for="confirmPasswordInput" class="form-label">Xác nhận mật khẩu mới</label>
                <input name="ConfirmPassword" type="password" class="form-control" id="confirmPasswordInput" autocomplete="new-password" placeholder="Xác nhận mật khẩu mới" required />
                <span class="password-toggle-icon" data-target-id="confirmPasswordInput"><i class="fas fa-eye"></i></span>
                <span class="text-danger" data-valmsg-for="ConfirmPassword"></span>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Đặt Lại Mật Khẩu</button>
                <button type="button" id="changePhoneNumberButton" class="btn btn-outline-secondary">Thay đổi SĐT</button>
            </div>
        </form>
    </div>

    <hr class="mt-4" />
    <p class="text-center">
        Nhớ mật khẩu? <a asp-action="Login" asp-controller="Account" class="btn-link">Đăng nhập</a>.
    </p>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const phoneNumberSection = document.getElementById('phoneNumberSection');
            const resetPasswordSection = document.getElementById('resetPasswordSection');
            const phoneNumberInput = document.getElementById('phoneNumberInput');
            const sendOtpButton = document.getElementById('sendOtpButton');
            const changePhoneNumberButton = document.getElementById('changePhoneNumberButton');
            const phoneNumberDisplay = document.getElementById('phoneNumberDisplay');
            const hiddenPhoneNumber = document.getElementById('hiddenPhoneNumber');
            const statusContainer = document.getElementById('status-container');
            const resetPasswordForm = document.getElementById('resetPasswordForm');

            function showStatus(message, type = 'info') {
                if (!statusContainer) return;
                const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
                statusContainer.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert"><i class="fas fa-${icon} me-2"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            }

            // Gửi OTP
            sendOtpButton.addEventListener('click', async function() {
                const phoneNumber = phoneNumberInput.value;
                if (!phoneNumber) {
                    showStatus('Vui lòng nhập số điện thoại.', 'danger');
                    return;
                }

                this.disabled = true;
                this.querySelector('.button-text').textContent = 'Đang gửi...';
                this.querySelector('.spinner-border')?.classList.remove('d-none');

                // Lấy AntiForgeryToken từ form reset password
                const antiForgeryToken = resetPasswordForm.querySelector('input[name="__RequestVerificationToken"]').value;

                try {
                    const response = await fetch('/Account/SendPasswordResetOtp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': antiForgeryToken },
                        body: JSON.stringify({ PhoneNumber: phoneNumber })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showStatus(data.message, 'success');
                        phoneNumberSection.style.display = 'none';
                        resetPasswordSection.style.display = 'block';
                        phoneNumberDisplay.textContent = phoneNumber;
                        hiddenPhoneNumber.value = phoneNumber;
                    } else {
                        showStatus(data.message || 'Lỗi gửi OTP. Vui lòng kiểm tra lại số điện thoại.', 'danger');
                        this.disabled = false;
                    }
                } catch (error) {
                    console.error("Lỗi khi gửi OTP:", error);
                    showStatus('Lỗi kết nối. Vui lòng thử lại.', 'danger');
                    this.disabled = false;
                } finally {
                    this.querySelector('.button-text').textContent = 'Gửi Mã OTP';
                    this.querySelector('.spinner-border')?.classList.add('d-none');
                }
            });

            // Quay lại nhập SĐT
            changePhoneNumberButton.addEventListener('click', function() {
                phoneNumberSection.style.display = 'block';
                resetPasswordSection.style.display = 'none';
                statusContainer.innerHTML = ''; // Xóa thông báo cũ
            });

            // Ẩn/hiện mật khẩu
            document.querySelectorAll('.password-toggle-icon').forEach(function (toggle) {
                toggle.addEventListener('click', function () {
                    const targetId = this.dataset.targetId;
                    const passwordInput = document.getElementById(targetId);
                    const icon = this.querySelector('i');
                    if (passwordInput && icon) {
                        if (passwordInput.type === 'password') {
                            passwordInput.type = 'text';
                            icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
                        } else {
                            passwordInput.type = 'password';
                            icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
                        }
                    }
                });
            });
        });
    </script>
}
